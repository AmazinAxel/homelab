<!DOCTYPE html>
<html lang="en-US">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="color-scheme" content="dark"/>
    <link rel="stylesheet" href="https://amazinaxel.com/css/reset.css"/>
    <link rel="stylesheet" href="https://amazinaxel.com/css/vars.css"/>
    <link rel="stylesheet" href="https://amazinaxel.com/css/typography.css"/>
    <link rel="stylesheet" href="https://amazinaxel.com/css/layout.css"/>
    <link rel="stylesheet" href="https://amazinaxel.com/css/other.css"/>
    <title>Homelab Air Quality</title>

    <style>
        #content { text-align: center; }
        h2 { font-size: 2.2rem; }
        h1, h2 { padding: 0.5rem; margin: 0; }
        hr { margin: 1rem; }
        #pmValues { display: flex; justify-content: center; gap: 2rem; opacity: 0.8; }
        #lastUpdatedText, #lastUpdated { color: var(--blue2); } #lastUpdated { font-weight: bold; }
        #chart {
            max-width: 600px;
            margin: 1rem auto;
            background: var(--blue3);
            border-radius: 0.3rem;
            box-shadow: 0 0 1rem var(--blue3);
        }
    </style>
    <link href="https://unpkg.com/uplot@1.6.17/dist/uPlot.min.css" rel="stylesheet">
    <script src="https://unpkg.com/uplot@1.6.17/dist/uPlot.iife.min.js"></script>
</head>
<body>
    <div id="content">
        <h1>Homelab Air Quality Station</h1>
        <hr>
        <h2>
            <span style="opacity: 0.9">Sensor AQI:</span>
            <span id="aqi"></span>
            <span id="qualityReport"></span>
        </h2>
        <div id="pmValues">
            <p><span style="opacity: 0.9">PM2.5:</span>
                <span id="pm25"></span>
                <span id="pm25Report"></span>
            </p>
            <p><span style="opacity: 0.9">PM2.5:</span>
                <span id="pm10"></span>
                <span id="pm10Report"></span>
            </p>
        </div>
        <h3>AQI history:</h3>
        <input type="checkbox" id="show7days" value="Show past 7 days">
        <div id="chart"></div>
        <p id="lastUpdatedText">Last updated at <span id="lastUpdated"></span></p>
        <hr>
        <h3>
            <a style="opacity: 0.9" href="https://fire.airnow.gov/#10.58/48.75/-122.4">Airnow AQI:</a>
            <span id="airnowSensorAQI"></span>
            <span id="airnowQuality"></span>
        </h3>
        <button class="button" onclick="refreshData()">Refresh data</button>
    </div>

    <script>
        const qualityReportElement = document.getElementById('qualityReport');
        const aqiElement = document.getElementById('aqi');
        const pm25Element = document.getElementById('pm25');
        const pm25ReportElement = document.getElementById('pm25Report');
        const pm10Element = document.getElementById('pm10');
        const pm10ReportElement = document.getElementById('pm10Report');
        const lastUpdatedElement = document.getElementById('lastUpdated');
        const airnowSensorAQIElement = document.getElementById('airnowSensorAQI');
        const airnowQualityElement = document.getElementById('airnowQuality');
        const refreshButtonElement = document.getElementsByClassName('button')[0];
        const chartElement = document.getElementById('chart');
        const get7Days = document.getElementById('show7days');

        async function refreshData() {
            refreshButtonElement.innerHTML = "Refreshing...";

            let response;
            if (get7Days.checked) {
                response = await fetch("/getdataFrom7Days");
            } else {
                response = await fetch("/getdata");
            }
            const airnowResponse = await fetch("https://www.airnowapi.org/aq/observation/zipCode/current/?format=application/json&zipCode=98226&distance=1&API_KEY=AIRNOW_TOKEN");

            if (!response.ok && !airnowResponse.ok) throw new Error("Failed to fetch local data");

            const data = await response.json();
            const airnowData = await airnowResponse.json();
            const airnowAQI = Math.max(...airnowData.map(entry => entry.AQI));

            const latestData = data.at(-1)
            const date = new Date(Number(latestData.timestamp)).toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });

            const pm25AQI = calculateAQI(latestData.pm25, pm25Breakpoints);
            const pm10AQI = calculateAQI(latestData.pm10, pm10Breakpoints);
            const AQI = Math.max(pm25AQI ?? 0, pm10AQI ?? 0);

            qualityReportElement.innerHTML = getFormattedAQIElement(AQI);
            aqiElement.innerHTML = AQI;
            pm25Element.innerHTML = pm25AQI;
            pm25ReportElement.innerHTML = getFormattedAQIElement(pm25AQI);
            pm10Element.innerHTML = pm10AQI;
            pm10ReportElement.innerHTML = getFormattedAQIElement(pm10AQI);
            lastUpdatedElement.innerHTML = date;

            airnowSensorAQIElement.innerHTML = airnowAQI;
            airnowQualityElement.innerHTML = getFormattedAQIElement(airnowAQI);
            refreshButtonElement.innerHTML = "Refresh data";

            // Render chart
            const timestamps = data.map(d => d.timestamp / 1000);
            const values = data.map(d =>
                (d.pm25 < d.pm10) ? calculateAQI(d.pm25, pm25Breakpoints) : calculateAQI(d.pm10, pm10Breakpoints)
            );
            const opts = {
                width: chartElement.offsetWidth,
                height: 300,
                scales: { x: { time: true }, y: { auto: true }},
                axes: [{
                    label: "Time",
                    values: (u, ticks) => ticks.map(t =>
                        new Date(t * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false })
                    )
                }],
                series: [{}, {
                    label: "AQI",
                    stroke: getFormattedAQIElement(AQI, true),
                    width: 3,
                }],
                cursor: {
                    x: false,
                    y: false,
                    points: { size: 8 }
                }
            };
            chartElement.innerHTML = ""; // Clear old chart
            new uPlot(opts, [timestamps, values], chartElement);
        };
        refreshData();

        function getFormattedAQIElement(aqi, shouldReturnColor = false) {
            let label, color;
            if (aqi <= 50) {
                label = "Good";
                color = "#a3be8c";
            } else if (aqi <= 100) {
                label = "Moderate";
                color = "#ebcb8b";
            } else if (aqi <= 150) {
                label = "USG";
                color = "#d08770";
            } else if (aqi <= 200) {
                label = "Unhealthy";
                color = "#bf616a";
            } else if (aqi <= 300) {
                label = "Very Unhealthy";
                color = "#b48ead";
            } else {
                label = "Hazardous";
                color = "#94628a";
            };
            if (shouldReturnColor) return color;
            return `<span style="color: ${color}"> (${label})</span>`;
        }

        // Get AQI from pm2.5 & pm10 monitor values
        function calculateAQI(concentration, breakpoints) {
            for (const bp of breakpoints) {
                const { cLow, cHigh, iLow, iHigh } = bp;
                if (concentration >= cLow && concentration <= cHigh)
                    return Math.round(((iHigh - iLow) / (cHigh - cLow)) * (concentration - cLow) + iLow);
            }
            return null; // Out of range
        }
        const pm25Breakpoints = [
            { cLow: 0.0,   cHigh: 12.0,   iLow: 0,   iHigh: 50 },
            { cLow: 12.1,  cHigh: 35.4,   iLow: 51,  iHigh: 100 },
            { cLow: 35.5,  cHigh: 55.4,   iLow: 101, iHigh: 150 },
            { cLow: 55.5,  cHigh: 150.4,  iLow: 151, iHigh: 200 },
            { cLow: 150.5, cHigh: 250.4,  iLow: 201, iHigh: 300 },
            { cLow: 250.5, cHigh: 500.4,  iLow: 301, iHigh: 500 },
        ];
        const pm10Breakpoints = [
            { cLow: 0,     cHigh: 54,     iLow: 0,   iHigh: 50 },
            { cLow: 55,    cHigh: 154,    iLow: 51,  iHigh: 100 },
            { cLow: 155,   cHigh: 254,    iLow: 101, iHigh: 150 },
            { cLow: 255,   cHigh: 354,    iLow: 151, iHigh: 200 },
            { cLow: 355,   cHigh: 424,    iLow: 201, iHigh: 300 },
            { cLow: 425,   cHigh: 604,    iLow: 301, iHigh: 500 },
        ];

        document.addEventListener('keydown', (event) => (event.key === 'r') && refreshData());
    </script>
</body>
</html>
